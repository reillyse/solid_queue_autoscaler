name: Release

on:
  # Only run after CI workflow completes successfully
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main, master]
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force release even if version unchanged (for initial release)'
        required: false
        default: 'false'
        type: boolean

jobs:
  release:
    name: Release to RubyGems
    runs-on: ubuntu-latest
    # Only run if CI workflow succeeded (not on workflow_dispatch which bypasses this)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need to compare with previous commit

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Check if version changed
        id: version_check
        run: |
          # Get current version
          CURRENT_VERSION=$(ruby -r ./lib/solid_queue_autoscaler/version.rb -e "puts SolidQueueAutoscaler::VERSION")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Check if force release was requested
          if [ "${{ inputs.force_release }}" == "true" ]; then
            echo "Force release requested"
            echo "version_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get previous version (from parent commit)
          git checkout HEAD~1 -- lib/solid_queue_autoscaler/version.rb 2>/dev/null || true
          PREVIOUS_VERSION=$(ruby -r ./lib/solid_queue_autoscaler/version.rb -e "puts SolidQueueAutoscaler::VERSION" 2>/dev/null || echo "0.0.0")
          
          # Restore current version
          git checkout HEAD -- lib/solid_queue_autoscaler/version.rb
          
          echo "previous_version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
            echo "version_changed=true" >> $GITHUB_OUTPUT
          else
            echo "Version unchanged at $CURRENT_VERSION"
            echo "version_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run tests before release
        if: steps.version_check.outputs.version_changed == 'true'
        run: bundle exec rake spec

      - name: Build gem
        if: steps.version_check.outputs.version_changed == 'true'
        run: gem build solid_queue_autoscaler.gemspec

      - name: Publish to RubyGems
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          mkdir -p $HOME/.gem
          touch $HOME/.gem/credentials
          chmod 0600 $HOME/.gem/credentials
          printf -- "---\n:rubygems_api_key: ${GEM_HOST_API_KEY}\n" > $HOME/.gem/credentials
          gem push solid_queue_autoscaler-${{ steps.version_check.outputs.current_version }}.gem
        env:
          GEM_HOST_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}

      - name: Create GitHub Release
        if: steps.version_check.outputs.version_changed == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version_check.outputs.current_version }}
          name: v${{ steps.version_check.outputs.current_version }}
          body: |
            ## Release v${{ steps.version_check.outputs.current_version }}
            
            See [CHANGELOG.md](https://github.com/reillyse/solid_queue_autoscaler/blob/main/CHANGELOG.md) for details.
            
            ### Installation
            ```ruby
            gem 'solid_queue_autoscaler', '~> ${{ steps.version_check.outputs.current_version }}'
            ```
          files: |
            solid_queue_autoscaler-${{ steps.version_check.outputs.current_version }}.gem
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip release (version unchanged)
        if: steps.version_check.outputs.version_changed == 'false'
        run: echo "Skipping release - version unchanged at ${{ steps.version_check.outputs.current_version }}"
