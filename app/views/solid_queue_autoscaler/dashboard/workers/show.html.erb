<div class="d-flex justify-between align-center mb-3">
  <h2>
    Worker: <%= @worker[:name] %>
    <% if @worker[:enabled] %>
      <span class="badge badge-success">Active</span>
    <% else %>
      <span class="badge badge-neutral">Disabled</span>
    <% end %>
    <% if @worker[:dry_run] %>
      <span class="badge badge-warning">Dry Run</span>
    <% end %>
  </h2>
  <div class="d-flex gap-2">
    <%= link_to '← Back', workers_path, class: 'btn btn-secondary btn-sm' %>
    <%= button_to 'Scale Now', scale_worker_path(@worker[:name]), method: :post, class: 'btn btn-primary btn-sm', disabled: !@worker[:enabled] %>
  </div>
</div>

<div class="grid grid-2 mb-3">
  <!-- Current Status -->
  <div class="card">
    <h3>Current Status</h3>
    
    <div class="d-flex justify-between align-center mb-2">
      <div>
        <strong class="text-info" style="font-size: 2rem;"><%= @worker[:current_workers] %></strong>
        <span class="text-muted">/ <%= @worker[:max_workers] %> workers</span>
      </div>
      <div class="text-muted">
        Min: <%= @worker[:min_workers] %> | Max: <%= @worker[:max_workers] %>
      </div>
    </div>
    
    <div class="progress-bar">
      <% pct = (@worker[:current_workers].to_f / @worker[:max_workers] * 100).round %>
      <div class="fill" style="width: <%= pct %>%; background: <%= pct > 80 ? 'var(--warning)' : 'var(--success)' %>;"></div>
    </div>
    
    <div class="grid grid-2 mt-2">
      <div>
        <div class="text-muted">Process Type</div>
        <code><%= @worker[:process_type] %></code>
      </div>
      <div>
        <div class="text-muted">Strategy</div>
        <code><%= @worker[:scaling_strategy] %></code>
      </div>
      <div>
        <div class="text-muted">Queues</div>
        <code><%= Array(@worker[:queues]).join(', ') %></code>
      </div>
    </div>
  </div>

  <!-- Metrics -->
  <div class="card">
    <h3>Current Metrics</h3>
    
    <div class="grid grid-2">
      <div class="mb-2">
        <div class="text-muted">Queue Depth</div>
        <strong class="<%= @worker[:metrics][:queue_depth] > @worker[:thresholds][:scale_up_queue_depth] ? 'text-danger' : '' %>" style="font-size: 1.5rem;">
          <%= @worker[:metrics][:queue_depth] %>
        </strong>
        <div class="text-muted" style="font-size: 0.8rem;">
          ↑ threshold: <%= @worker[:thresholds][:scale_up_queue_depth] %> | ↓ threshold: <%= @worker[:thresholds][:scale_down_queue_depth] %>
        </div>
      </div>
      
      <div class="mb-2">
        <div class="text-muted">Oldest Job Age</div>
        <strong class="<%= @worker[:metrics][:latency_seconds] > @worker[:thresholds][:scale_up_latency] ? 'text-danger' : '' %>" style="font-size: 1.5rem;">
          <%= @worker[:metrics][:latency_seconds].round %>s
        </strong>
        <div class="text-muted" style="font-size: 0.8rem;">
          ↑ threshold: <%= @worker[:thresholds][:scale_up_latency] %>s | ↓ threshold: <%= @worker[:thresholds][:scale_down_latency] %>s
        </div>
      </div>
      
      <div>
        <div class="text-muted">Jobs/Minute</div>
        <strong style="font-size: 1.5rem;"><%= @worker[:metrics][:jobs_per_minute] %></strong>
      </div>
      
      <div>
        <div class="text-muted">Claimed Jobs</div>
        <strong style="font-size: 1.5rem;"><%= @worker[:metrics][:claimed_jobs] %></strong>
      </div>
      
      <div>
        <div class="text-muted">Failed Jobs</div>
        <strong class="<%= @worker[:metrics][:failed_jobs] > 0 ? 'text-danger' : '' %>" style="font-size: 1.5rem;">
          <%= @worker[:metrics][:failed_jobs] %>
        </strong>
      </div>
      
      <div>
        <div class="text-muted">Active Workers</div>
        <strong style="font-size: 1.5rem;"><%= @worker[:metrics][:active_workers] %></strong>
      </div>
    </div>
  </div>
</div>

<!-- Cooldowns -->
<div class="card mb-3">
  <h3>Cooldown Status</h3>
  
  <div class="grid grid-2">
    <div>
      <div class="text-muted mb-1">Scale Up Cooldown</div>
      <% if @worker[:cooldowns][:scale_up_remaining] > 0 %>
        <span class="badge badge-info">
          <%= @worker[:cooldowns][:scale_up_remaining] %>s remaining
        </span>
      <% else %>
        <span class="text-success">Ready</span>
      <% end %>
      <% if @worker[:cooldowns][:last_scale_up] %>
        <div class="text-muted" style="font-size: 0.8rem;">
          Last: <%= @worker[:cooldowns][:last_scale_up].strftime('%Y-%m-%d %H:%M:%S') %>
        </div>
      <% end %>
    </div>
    
    <div>
      <div class="text-muted mb-1">Scale Down Cooldown</div>
      <% if @worker[:cooldowns][:scale_down_remaining] > 0 %>
        <span class="badge badge-warning">
          <%= @worker[:cooldowns][:scale_down_remaining] %>s remaining
        </span>
      <% else %>
        <span class="text-success">Ready</span>
      <% end %>
      <% if @worker[:cooldowns][:last_scale_down] %>
        <div class="text-muted" style="font-size: 0.8rem;">
          Last: <%= @worker[:cooldowns][:last_scale_down].strftime('%Y-%m-%d %H:%M:%S') %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Recent Events -->
<div class="card">
  <div class="d-flex justify-between align-center mb-2">
    <h3>Recent Events</h3>
    <%= link_to 'View All', events_path(worker: @worker[:name]), class: 'btn btn-secondary btn-sm' %>
  </div>

  <% if !events_available? %>
    <p class="text-muted">
      Events table not found. Run:
      <code>rails generate solid_queue_autoscaler:dashboard</code>
    </p>
  <% elsif @events.empty? %>
    <p class="text-muted">No scale events recorded for this worker.</p>
  <% else %>
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Action</th>
          <th>Workers</th>
          <th>Queue Depth</th>
          <th>Latency</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody>
        <% @events.each do |event| %>
          <tr>
            <td>
              <div><%= event.created_at.strftime('%Y-%m-%d') %></div>
              <div class="time-ago"><%= event.created_at.strftime('%H:%M:%S') %></div>
            </td>
            <td>
              <% case event.action %>
              <% when 'scale_up' %>
                <span class="badge badge-success">↑ Scale Up</span>
              <% when 'scale_down' %>
                <span class="badge badge-warning">↓ Scale Down</span>
              <% when 'no_change' %>
                <span class="badge badge-neutral">— No Change</span>
              <% when 'skipped' %>
                <span class="badge badge-info">⏭ Skipped</span>
              <% when 'error' %>
                <span class="badge badge-danger">✕ Error</span>
              <% end %>
              <% if event.dry_run %>
                <span class="badge badge-neutral">DRY</span>
              <% end %>
            </td>
            <td>
              <% if event.scaled? %>
                <strong><%= event.from_workers %></strong> → <strong><%= event.to_workers %></strong>
              <% else %>
                <%= event.from_workers %>
              <% end %>
            </td>
            <td><%= event.queue_depth %></td>
            <td><%= event.latency_seconds.round %>s</td>
            <td class="text-muted"><%= event.reason %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>
</div>
