# frozen_string_literal: true

class CreateSolidQueueAutoscalerEvents < ActiveRecord::Migration<%= migration_version %>
  # Use the same database connection as SolidQueue for multi-database setups
  def self.connection
    if defined?(SolidQueue::Record) && SolidQueue::Record.respond_to?(:connection)
      SolidQueue::Record.connection
    else
      super
    end
  end

  def change
    create_table :solid_queue_autoscaler_events do |t|
      t.string :worker_name, null: false
      t.string :action, null: false
      t.integer :from_workers, null: false, default: 0
      t.integer :to_workers, null: false, default: 0
      t.text :reason
      t.integer :queue_depth, default: 0
      t.float :latency_seconds, default: 0.0
      t.jsonb :metrics_json
      t.boolean :dry_run, default: false

      t.datetime :created_at, null: false
    end

    add_index :solid_queue_autoscaler_events, :worker_name
    add_index :solid_queue_autoscaler_events, :action
    add_index :solid_queue_autoscaler_events, :created_at
    add_index :solid_queue_autoscaler_events, %i[worker_name created_at]
  end
end
